name: Build and Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  update-version-info:
    uses: ./.github/workflows/update-version-info.yml
    permissions:
      contents: write
    with:
      tag_name: ${{ github.ref_name }}
      ref: ${{ github.ref }}

  commit-and-move-tag:
    needs: update-version-info
    if: ${{ needs.update-version-info.outputs.has_changes == 'true' }}
    uses: ./.github/workflows/commit-and-move-tag.yml
    permissions:
      contents: write
    with:
      tag_name: ${{ needs.update-version-info.outputs.tag_name }}
      version: ${{ needs.update-version-info.outputs.version }}
      file_path: src/gui/ALVersionInfo.py

  build-and-release:
    runs-on: windows-latest
    needs: [update-version-info, commit-and-move-tag]
    if: always() && needs.update-version-info.result == 'success'
    permissions:
      contents: write

    steps:
    - name: Checkout code with updated version info
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Get version info from previous job
      id: get_tag
      run: |
        $tagName = "${{ needs.update-version-info.outputs.tag_name }}"
        $version = "${{ needs.update-version-info.outputs.version }}"

        echo "TAG_NAME=$tagName" >> $env:GITHUB_OUTPUT
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        Write-Host "✓ Tag: $tagName"
        Write-Host "✓ Version: $version"
      shell: pwsh

    - name: Verify ALVersionInfo.py was updated
      run: |
        $versionInfoFile = "src/gui/ALVersionInfo.py"
        Write-Host "Verifying $versionInfoFile content:"
        Write-Host "================================"
        Get-Content $versionInfoFile | Write-Host
        Write-Host "================================"
      shell: pwsh

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirement.txt

    - name: Fix ddddocr compatibility and copy model files
      run: |
        $ddddocrPath = python -c "import ddddocr, os; print(os.path.dirname(ddddocr.__file__))"
        Write-Host "ddddocr package location: $ddddocrPath"

        $initFile = Join-Path $ddddocrPath "__init__.py"
        if (Test-Path $initFile) {
          Write-Host "Fixing ddddocr compatibility in: $initFile"
          (Get-Content $initFile) -replace 'Image\.ANTIALIAS', 'Image.Resampling.LANCZOS' | Set-Content $initFile
          Write-Host "✓ Fixed: Image.ANTIALIAS -> Image.Resampling.LANCZOS"
        } else {
          Write-Error "✗ ddddocr __init__.py not found"
          exit 1
        }

        if (-not (Test-Path "model")) {
          New-Item -ItemType Directory -Path "model" | Out-Null
          Write-Host "✓ Created model directory"
        }

        $onnxSource = Join-Path $ddddocrPath "common.onnx"
        $onnxDest = "model/common.onnx"
        if (Test-Path $onnxSource) {
          Copy-Item $onnxSource $onnxDest -Force
          Write-Host "✓ Copied ONNX model from: $onnxSource"
          Write-Host "✓ ONNX model copied to: $onnxDest"
        } else {
          Write-Error "✗ ONNX model not found in ddddocr package: $onnxSource"
          exit 1
        }

        if (Test-Path $onnxDest) {
          $fileSize = (Get-Item $onnxDest).Length / 1MB
          Write-Host "✓ Model file verified: $onnxDest (Size: $([math]::Round($fileSize, 2)) MB)"
        } else {
          Write-Error "✗ Failed to copy model file"
          exit 1
        }
      shell: pwsh

    - name: Compile Qt UI files
      run: |
        cd src/gui/batchs
        ./compile_ui.bat
      shell: cmd

    - name: Compile Qt Resource files
      run: |
        cd src/gui/batchs
        ./compile_rc.bat
      shell: cmd

    - name: Generate Main.spec dynamically
      run: |
        $version = "${{ steps.get_tag.outputs.VERSION }}"
        $exeName = "AutoLibrary-$version"

        Write-Host "Generating Main.spec for version: $version"
        Write-Host "Executable name: $exeName"

        $specLines = @(
          "# -*- mode: python ; coding: utf-8 -*-"
          ""
          ""
          "a = Analysis("
          "    ['src\\Main.py'],"
          "    pathex=[],"
          "    binaries=[],"
          "    datas=["
          "        ('model\\common.onnx', 'ddddocr'),"
          "        ('src\\gui\\icons\\AutoLibrary_32x32.ico', 'gui\\icons'),"
          "    ],"
          "    hiddenimports=[],"
          "    hookspath=[],"
          "    hooksconfig={},"
          "    runtime_hooks=[],"
          "    excludes=[],"
          "    noarchive=False,"
          "    optimize=0,"
          ")"
          "pyz = PYZ(a.pure)"
          ""
          "exe = EXE("
          "    pyz,"
          "    a.scripts,"
          "    a.binaries,"
          "    a.datas,"
          "    [],"
          "    name='$exeName',"
          "    debug=False,"
          "    bootloader_ignore_signals=False,"
          "    strip=False,"
          "    upx=True,"
          "    upx_exclude=[],"
          "    runtime_tmpdir=None,"
          "    console=False,"
          "    disable_windowed_traceback=False,"
          "    argv_emulation=False,"
          "    target_arch=None,"
          "    codesign_identity=None,"
          "    entitlements_file=None,"
          "    icon=['src\\gui\\icons\\AutoLibrary_32x32.ico'],"
          ")"
        )

        $specLines | Out-File -FilePath "Main.spec" -Encoding UTF8

        Write-Host "✓ Main.spec generated successfully"
        Write-Host "`n=== Generated Main.spec ==="
        Get-Content "Main.spec" | Write-Host
        Write-Host "==========================`n"
      shell: pwsh

    - name: Build with PyInstaller
      run: |
        pyinstaller Main.spec

    - name: Create Release Archive
      run: |
        $tagName = "${{ steps.get_tag.outputs.TAG_NAME }}"
        $version = "${{ steps.get_tag.outputs.VERSION }}"
        $exeName = "AutoLibrary-$version.exe"
        $zipName = "AutoLibrary.$tagName-windows-x86_64.zip"

        Write-Host "Looking for executable: dist/$exeName"

        if (Test-Path "dist/$exeName") {
          Compress-Archive -Path "dist/$exeName" -DestinationPath $zipName
          Write-Host "✓ Created release archive: $zipName"
        } else {
          Write-Error "✗ Executable not found: dist/$exeName"
          Write-Host "Files in dist directory:"
          Get-ChildItem "dist" | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
      shell: pwsh

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_tag.outputs.TAG_NAME }}
        name: AutoLibrary ${{ steps.get_tag.outputs.TAG_NAME }}
        files: |
          AutoLibrary.${{ steps.get_tag.outputs.TAG_NAME }}-windows-x86_64.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ### 下载获取
          - **Windows x86_64**: `AutoLibrary.${{ steps.get_tag.outputs.TAG_NAME }}-windows-x86_64.zip`

          ### 如何使用
          1. 下载 `AutoLibrary.${{ steps.get_tag.outputs.TAG_NAME }}-windows-x86_64.zip` 文件
          2. 解压到任意目录
          3. 下载对应浏览器的驱动文件
          4. 运行 `AutoLibrary-${{ steps.get_tag.outputs.VERSION }}.exe` (首次运行会初始化配置文件)
          5. 按照提示操作即可

          更多详情请访问 [AutoLibrary 网站](http://autolibrary.cv) 和查看 [帮助手册](https://autolibrary.cv/docs/manual_lists.html)

          ---
          **完整更新日志见下方自动生成的 Release Notes**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
